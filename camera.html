<script>
    let mediaRecorder;
    let recordedChunks = [];
    let isPaused = false;
    let stream;
    let timeLimit;
    let remainingTime;
    let timeoutID;
    let countdownInterval;

    const API_URL = "https://a906-113-190-231-181.ngrok-free.app/detect_video"; // Đổi đúng URL của Ngrok

    document.getElementById("start-btn").addEventListener("click", async function () {
        if (!isPaused) {
            timeLimit = parseInt(document.getElementById("time-select").value);
            remainingTime = timeLimit;

            document.getElementById("countdown").innerText = `Thời gian còn lại: ${remainingTime}s`;

            // Cập nhật bộ đếm mỗi giây
            countdownInterval = setInterval(() => {
                if (!isPaused && remainingTime > 0) {
                    remainingTime--;
                    document.getElementById("countdown").innerText = `Thời gian còn lại: ${remainingTime}s`;
                }
            }, 1000);

            // Mở camera
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById("video").srcObject = stream;
            } catch (error) {
                console.error("Không thể mở camera:", error);
                alert("Không thể truy cập camera. Vui lòng kiểm tra quyền camera.");
                return;
            }

            // Khởi tạo MediaRecorder
            mediaRecorder = new MediaRecorder(stream);
            recordedChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = async () => {
                clearInterval(countdownInterval);
                document.getElementById("countdown").innerText = "Thời gian còn lại: Hoàn thành";

                const blob = new Blob(recordedChunks, { type: "video/mp4" }); // Sửa đổi định dạng nếu cần
                const formData = new FormData();
                formData.append("file", blob, "recorded-video.mp4");

                try {
                    // Gửi video lên server
                    const response = await fetch(API_URL, {
                        method: "POST",
                        body: formData,
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const result = await response.json();

                    console.log("Server response:", result);

                    // Kiểm tra nếu server có trả về drowsy_counter
                    if (result.drowsy_counter !== undefined) {
                        document.getElementById("result").innerText = `Số lần buồn ngủ: ${result.drowsy_counter}`;
                    } else {
                        document.getElementById("result").innerText = "Không có dữ liệu buồn ngủ trả về.";
                    }
                } catch (error) {
                    console.error("Lỗi khi gửi video:", error);
                    document.getElementById("result").innerText = "Lỗi khi phân tích video.";
                }
            };

            mediaRecorder.start();
            document.getElementById("pause-btn").disabled = false;

            // Dừng ghi sau thời gian đã chọn
            timeoutID = setTimeout(() => {
                mediaRecorder.stop();
                stream.getTracks().forEach(track => track.stop());
                document.getElementById("pause-btn").disabled = true;
            }, timeLimit * 1000);
        } else {
            mediaRecorder.resume();
            isPaused = false;
            document.getElementById("pause-btn").innerText = "Tạm dừng";
        }
    });

    document.getElementById("pause-btn").addEventListener("click", function () {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.pause();
            isPaused = true;
            document.getElementById("pause-btn").innerText = "Tiếp tục";
            clearTimeout(timeoutID);
            clearInterval(countdownInterval);
        } else if (mediaRecorder && mediaRecorder.state === "paused") {
            mediaRecorder.resume();
            isPaused = false;
            document.getElementById("pause-btn").innerText = "Tạm dừng";
        }
    });
</script>
